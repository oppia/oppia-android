# TODO(#1532): Rename file to 'BUILD' post-Gradle.
'''
This library contains the app's core source files and functionality
'''
load("@rules_jvm_external//:defs.bzl", "artifact")
load("@dagger//:workspace_defs.bzl", "dagger_rules")
load("@tools_android//tools/crashlytics:defs.bzl", "crashlytics_android_library")
load("@tools_android//tools/googleservices:defs.bzl", "google_services_xml")
load("@io_bazel_rules_kotlin//kotlin:kotlin.bzl", "kt_android_library")

# Source files for annotations library.
ANNOTATION_FILES = [
    "src/main/java/org/oppia/app/activity/ActivityScope.kt",
    "src/main/java/org/oppia/app/fragment/FragmentScope.kt",
    "src/main/java/org/oppia/app/utility/KeyboardHelper.kt",
]

# Source files for listener library.
LISTENER_FILES = [
    "src/main/java/org/oppia/app/administratorcontrols/RouteToAppVersionListener.kt",
    "src/main/java/org/oppia/app/administratorcontrols/RouteToProfileListListener.kt",
    "src/main/java/org/oppia/app/drawer/RouteToProfileProgressListener.kt",
    "src/main/java/org/oppia/app/help/faq/RouteToFAQSingleListener.kt",
    "src/main/java/org/oppia/app/help/RouteToFAQListListener.kt",
    "src/main/java/org/oppia/app/home/recentlyplayed/OngoingStoryClickListener.kt",
    "src/main/java/org/oppia/app/home/RouteToRecentlyPlayedListener.kt",
    "src/main/java/org/oppia/app/home/RouteToTopicPlayStoryListener.kt",
    "src/main/java/org/oppia/app/home/topiclist/TopicSummaryClickListener.kt",
    "src/main/java/org/oppia/app/onboarding/RouteToProfileListListener.kt",
    "src/main/java/org/oppia/app/options/RouteToAppLanguageListListener.kt",
    "src/main/java/org/oppia/app/options/RouteToAudioLanguageListListener.kt",
    "src/main/java/org/oppia/app/options/RouteToStoryTextSizeListener.kt",
    "src/main/java/org/oppia/app/player/audio/LanguageInterface.kt",
    "src/main/java/org/oppia/app/player/state/answerhandling/InteractionAnswerErrorOrAvailabilityCheckReceiver.kt",
    "src/main/java/org/oppia/app/player/state/answerhandling/InteractionAnswerHandler.kt",
    "src/main/java/org/oppia/app/player/state/listener/ContinueNavigationButtonListener.kt",
    "src/main/java/org/oppia/app/player/state/listener/NextNavigationButtonListener.kt",
    "src/main/java/org/oppia/app/player/state/listener/PreviousNavigationButtonListener.kt",
    "src/main/java/org/oppia/app/player/state/listener/PreviousResponsesHeaderClickListener.kt",
    "src/main/java/org/oppia/app/player/state/listener/ReplayButtonListener.kt",
    "src/main/java/org/oppia/app/player/state/listener/ReturnToTopicNavigationButtonListener.kt",
    "src/main/java/org/oppia/app/player/state/listener/RouteToHintsAndSolutionListener.kt",
    "src/main/java/org/oppia/app/player/state/listener/StateKeyboardButtonListener.kt",
    "src/main/java/org/oppia/app/player/state/listener/SubmitNavigationButtonListener.kt",
    "src/main/java/org/oppia/app/profile/RouteToAdminPinListener.kt",
    "src/main/java/org/oppia/app/profileprogress/ProfilePictureClickListener.kt",
    "src/main/java/org/oppia/app/profileprogress/RouteToCompletedStoryListListener.kt",
    "src/main/java/org/oppia/app/profileprogress/RouteToOngoingTopicListListener.kt",
    "src/main/java/org/oppia/app/recyclerview/OnDragEndedListener.kt",
    "src/main/java/org/oppia/app/recyclerview/OnItemDragListener.kt",
    "src/main/java/org/oppia/app/story/ExplorationSelectionListener.kt",
    "src/main/java/org/oppia/app/topic/lessons/StorySummarySelector.kt",
    "src/main/java/org/oppia/app/topic/revision/RevisionSubtopicSelector.kt",
    "src/main/java/org/oppia/app/topic/revisioncard/ReturnToTopicClickListener.kt",
    "src/main/java/org/oppia/app/topic/RouteToRevisionCardListener.kt",
    "src/main/java/org/oppia/app/utility/OnClickableAreaClickedListener.kt",
    "src/main/java/org/oppia/app/utility/RegionClickEvent.kt",
]

# TODO(#1617): Remove genrules post-gradle
# Files altered by genrules to be excluded in the app library
ALTERED_VIEW_MODELS = [
    "src/main/java/org/oppia/app/administratorcontrols/administratorcontrolsitemviewmodel/AdministratorControlsAccountActionsViewModel.kt",
    "src/main/java/org/oppia/app/help/faq/FAQListViewModel.kt",
    "src/main/java/org/oppia/app/help/HelpItemViewModel.kt",
    "src/main/java/org/oppia/app/help/HelpListViewModel.kt",
    "src/main/java/org/oppia/app/onboarding/OnboadingSlideViewModel.kt",
    "src/main/java/org/oppia/app/onboarding/OnboardingViewModel.kt",
    "src/main/java/org/oppia/app/parser/StringToFractionParser.kt",
    "src/main/java/org/oppia/app/parser/StringToNumberParser.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/FractionInteractionViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/ImageRegionSelectionInteractionViewModel.kt",
    "src/main/java/org/oppia/app/topic/info/TopicInfoViewModel.kt",
]

# Source files for view_model library
VIEW_MODEL_FILES = [
    "src/main/java/org/oppia/app/administratorcontrols/administratorcontrolsitemviewmodel/AdministratorControlsAppInformationViewModel.kt",
    "src/main/java/org/oppia/app/administratorcontrols/administratorcontrolsitemviewmodel/AdministratorControlsDownloadPermissionsViewModel.kt",
    "src/main/java/org/oppia/app/administratorcontrols/administratorcontrolsitemviewmodel/AdministratorControlsGeneralViewModel.kt",
    "src/main/java/org/oppia/app/administratorcontrols/administratorcontrolsitemviewmodel/AdministratorControlsItemViewModel.kt",
    "src/main/java/org/oppia/app/administratorcontrols/administratorcontrolsitemviewmodel/AdministratorControlsProfileViewModel.kt",
    "src/main/java/org/oppia/app/administratorcontrols/AdministratorControlsViewModel.kt",
    "src/main/java/org/oppia/app/administratorcontrols/appversion/AppVersionViewModel.kt",
    "src/main/java/org/oppia/app/completedstorylist/CompletedStoryItemViewModel.kt",
    "src/main/java/org/oppia/app/completedstorylist/CompletedStoryListViewModel.kt",
    "src/main/java/org/oppia/app/drawer/NavigationDrawerFooterViewModel.kt",
    "src/main/java/org/oppia/app/drawer/NavigationDrawerHeaderViewModel.kt",
    "src/main/java/org/oppia/app/help/faq/faqItemViewModel/FAQContentViewModel.kt",
    "src/main/java/org/oppia/app/help/faq/faqItemViewModel/FAQHeaderViewModel.kt",
    "src/main/java/org/oppia/app/help/faq/faqItemViewModel/FAQItemViewModel.kt",
    "src/main/java/org/oppia/app/help/HelpItems.kt",
    "src/main/java/org/oppia/app/hintsandsolution/HintsAndSolutionItemViewModel.kt",
    "src/main/java/org/oppia/app/hintsandsolution/HintsViewModel.kt",
    "src/main/java/org/oppia/app/hintsandsolution/SolutionViewModel.kt",
    "src/main/java/org/oppia/app/home/HomeItemViewModel.kt",
    "src/main/java/org/oppia/app/home/recentlyplayed/OngoingStoryViewModel.kt",
    "src/main/java/org/oppia/app/home/recentlyplayed/RecentlyPlayedItemViewModel.kt",
    "src/main/java/org/oppia/app/home/recentlyplayed/SectionTitleViewModel.kt",
    "src/main/java/org/oppia/app/home/topiclist/AllTopicsViewModel.kt",
    "src/main/java/org/oppia/app/home/topiclist/PromotedStoryListViewModel.kt",
    "src/main/java/org/oppia/app/home/topiclist/PromotedStoryViewModel.kt",
    "src/main/java/org/oppia/app/home/topiclist/TopicSummaryViewModel.kt",
    "src/main/java/org/oppia/app/home/UserAppHistoryViewModel.kt",
    "src/main/java/org/oppia/app/home/WelcomeViewModel.kt",
    "src/main/java/org/oppia/app/onboarding/OnboardingSlideFinalViewModel.kt",
    "src/main/java/org/oppia/app/onboarding/ViewPagerSlide.kt",
    "src/main/java/org/oppia/app/ongoingtopiclist/OngoingTopicItemViewModel.kt",
    "src/main/java/org/oppia/app/ongoingtopiclist/OngoingTopicListViewModel.kt",
    "src/main/java/org/oppia/app/options/OptionControlsViewModel.kt",
    "src/main/java/org/oppia/app/options/OptionsAppLanguageViewModel.kt",
    "src/main/java/org/oppia/app/options/OptionsAudioLanguageViewModel.kt",
    "src/main/java/org/oppia/app/options/OptionsItemViewModel.kt",
    "src/main/java/org/oppia/app/options/OptionsStoryTextSizeViewModel.kt",
    "src/main/java/org/oppia/app/player/audio/AudioViewModel.kt",
    "src/main/java/org/oppia/app/player/exploration/ExplorationViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/ContentViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/ContinueInteractionViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/ContinueNavigationButtonViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/DragAndDropSortInteractionViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/DragDropInteractionContentViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/FeedbackViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/NextButtonViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/NumericInputViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/PreviousButtonViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/PreviousResponsesHeaderViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/ReplayButtonViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/ReturnToTopicButtonViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/SelectionInteractionContentViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/SelectionInteractionViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/StateItemViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/SubmitButtonViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/SubmittedAnswerViewModel.kt",
    "src/main/java/org/oppia/app/player/state/itemviewmodel/TextInputViewModel.kt",
    "src/main/java/org/oppia/app/player/state/StateViewModel.kt",
    "src/main/java/org/oppia/app/player/state/testing/StateFragmentTestViewModel.kt",
    "src/main/java/org/oppia/app/profile/AddProfileViewModel.kt",
    "src/main/java/org/oppia/app/profile/AdminAuthViewModel.kt",
    "src/main/java/org/oppia/app/profile/AdminPinViewModel.kt",
    "src/main/java/org/oppia/app/profile/AdminSettingsViewModel.kt",
    "src/main/java/org/oppia/app/profile/PinPasswordViewModel.kt",
    "src/main/java/org/oppia/app/profile/ProfileChooserViewModel.kt",
    "src/main/java/org/oppia/app/profile/ResetPinViewModel.kt",
    "src/main/java/org/oppia/app/profileprogress/ProfilePictureActivityViewModel.kt",
    "src/main/java/org/oppia/app/profileprogress/ProfileProgressHeaderViewModel.kt",
    "src/main/java/org/oppia/app/profileprogress/ProfileProgressItemViewModel.kt",
    "src/main/java/org/oppia/app/profileprogress/ProfileProgressViewModel.kt",
    "src/main/java/org/oppia/app/profileprogress/RecentlyPlayedStorySummaryViewModel.kt",
    "src/main/java/org/oppia/app/recyclerview/BindableAdapter.kt",
    "src/main/java/org/oppia/app/recyclerview/DividerItemDecorator.kt",
    "src/main/java/org/oppia/app/recyclerview/DragAndDropItemFacilitator.kt",
    "src/main/java/org/oppia/app/settings/profile/ProfileEditViewModel.kt",
    "src/main/java/org/oppia/app/settings/profile/ProfileListViewModel.kt",
    "src/main/java/org/oppia/app/settings/profile/ProfileRenameViewModel.kt",
    "src/main/java/org/oppia/app/settings/profile/ProfileResetPinViewModel.kt",
    "src/main/java/org/oppia/app/shim/IntentFactoryShim.kt",
    "src/main/java/org/oppia/app/story/StoryFragmentScroller.kt",
    "src/main/java/org/oppia/app/story/storyitemviewmodel/StoryChapterSummaryViewModel.kt",
    "src/main/java/org/oppia/app/story/storyitemviewmodel/StoryHeaderViewModel.kt",
    "src/main/java/org/oppia/app/story/storyitemviewmodel/StoryItemViewModel.kt",
    "src/main/java/org/oppia/app/story/StoryViewModel.kt",
    "src/main/java/org/oppia/app/testing/BindableAdapterTestViewModel.kt",
    "src/main/java/org/oppia/app/topic/conceptcard/ConceptCardViewModel.kt",
    "src/main/java/org/oppia/app/topic/lessons/StorySummaryViewModel.kt",
    "src/main/java/org/oppia/app/topic/lessons/TopicLessonsItemViewModel.kt",
    "src/main/java/org/oppia/app/topic/lessons/TopicLessonsTitleViewModel.kt",
    "src/main/java/org/oppia/app/topic/practice/practiceitemviewmodel/TopicPracticeFooterViewModel.kt",
    "src/main/java/org/oppia/app/topic/practice/practiceitemviewmodel/TopicPracticeHeaderViewModel.kt",
    "src/main/java/org/oppia/app/topic/practice/practiceitemviewmodel/TopicPracticeItemViewModel.kt",
    "src/main/java/org/oppia/app/topic/practice/practiceitemviewmodel/TopicPracticeSubtopicViewModel.kt",
    "src/main/java/org/oppia/app/topic/practice/TopicPracticeViewModel.kt",
    "src/main/java/org/oppia/app/topic/questionplayer/QuestionPlayerViewModel.kt",
    "src/main/java/org/oppia/app/topic/revision/revisionitemviewmodel/TopicRevisionItemViewModel.kt",
    "src/main/java/org/oppia/app/topic/revision/TopicRevisionViewModel.kt",
    "src/main/java/org/oppia/app/topic/revisioncard/RevisionCardViewModel.kt",
    "src/main/java/org/oppia/app/topic/TopicViewModel.kt",
    "src/main/java/org/oppia/app/viewmodel/ObservableArrayList.kt",
    "src/main/java/org/oppia/app/viewmodel/ObservableViewModel.kt",
    "src/main/java/org/oppia/app/walkthrough/end/WalkthroughFinalViewModel.kt",
    "src/main/java/org/oppia/app/walkthrough/topiclist/topiclistviewmodel/WalkthroughTopicHeaderViewModel.kt",
    "src/main/java/org/oppia/app/walkthrough/topiclist/topiclistviewmodel/WalkthroughTopicSummaryViewModel.kt",
    "src/main/java/org/oppia/app/walkthrough/topiclist/WalkthroughTopicItemViewModel.kt",
    "src/main/java/org/oppia/app/walkthrough/topiclist/WalkthroughTopicViewModel.kt",
    "src/main/java/org/oppia/app/walkthrough/WalkthroughViewModel.kt",
    "src/main/java/org/oppia/app/walkthrough/welcome/WalkthroughWelcomeViewModel.kt",
] + [
    "update_" + altered_view_models[0:-3]
    for altered_view_models in ALTERED_VIEW_MODELS
]

# TODO(#1617): Remove genrules post-gradle
'''
Genrule for source files in the view_models library.

Because each databinding library must have a unique package name and manifest, resources must be
imported using the proper package name when building with Bazel. This genrule alters those imports
in order to keep Gradle building.
'''
[genrule(
    name = "update_" + file[0:-3],
    srcs = [file],
    outs = [file[0:-3] + "_updated.kt"],
    cmd = '''
    cat $(SRCS) |
    sed 's/import org.oppia.app.R/import org.oppia.app.vm.R/g' > $(OUTS)
    ''',
)
for file in ALTERED_VIEW_MODELS]

# TODO(#1617): Remove genrules post-gradle
# View files altered by genrules to be excluded in the app library.
ALTERED_VIEWS = [
    "src/main/java/org/oppia/app/customview/LessonThumbnailImageView.kt",
    "src/main/java/org/oppia/app/customview/SegmentedCircularProgressView.kt",
    "src/main/java/org/oppia/app/profile/ProfileInputView.kt",
    "src/main/java/org/oppia/app/utility/ClickableAreasImage.kt",
]

# Source files and genrule targets for views library.
VIEW_FILES = [
    "src/main/java/org/oppia/app/customview/interaction/FractionInputInteractionView.kt",
    "src/main/java/org/oppia/app/customview/interaction/NumericInputInteractionView.kt",
    "src/main/java/org/oppia/app/customview/interaction/TextInputInteractionView.kt",
    "src/main/java/org/oppia/app/player/state/DragDropSortInteractionView.kt",
    "src/main/java/org/oppia/app/player/state/ImageRegionSelectionInteractionView.kt",
    "src/main/java/org/oppia/app/player/state/SelectionInteractionView.kt",
    "src/main/java/org/oppia/app/shim/ViewBindingShim.kt",
    "src/main/java/org/oppia/app/shim/ViewComponentFactory.kt",
    "src/main/java/org/oppia/app/view/ViewComponent.kt",
    "src/main/java/org/oppia/app/view/ViewScope.kt",
] + [
    "update_" + altered_views[0:-3]
    for altered_views in ALTERED_VIEWS
]

# TODO(#1617): Remove genrules post-gradle
'''
Genrule for source files in the views library.

Because each databinding library must have a unique package name and manifest, resources must be
imported using the proper package name when building with Bazel. This genrule alters those imports
in order to keep Gradle building.
'''
[genrule(
     name = "update_" + file[0:-3],
     srcs = [file],
     outs = [file[0:-3] + "_updated.kt"],
     cmd = '''
     cat $(SRCS) |
     sed 's/import org.oppia.app.R/import org.oppia.app.views.R/g' > $(OUTS)
     ''',
 )
for file in ALTERED_VIEWS]

# Library for non-layout resource files
android_library(
    name = "resources",
    custom_package = "org.oppia.app",
    manifest = "src/main/AndroidManifest.xml",
    resource_files = glob(["src/main/res/**",], exclude = ["src/main/res/layout*/**"]),
    exports_manifest = True,
    deps = [
        artifact("com.google.android.material:material"),
    ],
    visibility = ["//visibility:private"],
)

# Library for listener files required to build views and view_model libraries
kt_android_library(
    name = "listeners",
    custom_package = "org.oppia.app",
    srcs = LISTENER_FILES,
    deps = [
        ":dagger",
        "//model",
        artifact("androidx.recyclerview:recyclerview:1.0.0"),
    ],
    visibility = ["//visibility:private"],
)

# Library for all view files required to build layout files
kt_android_library(
    name = "views",
    custom_package = "org.oppia.app.views",
    manifest = "src/main/ViewsManifest.xml",
    srcs = VIEW_FILES,
    deps = [
        ":annotations",
        ":listeners",
        ":resources",
        ":view_models",
        "//model",
        "@circularimageview//circularimageview:circular_image_view",
        artifact("androidx.appcompat:appcompat"),
        artifact("androidx.core:core-ktx"),
        artifact("androidx.databinding:databinding-common"),
        artifact("androidx.databinding:databinding-runtime"),
    ],
    visibility = ["//visibility:public"],
)

# Library for scope annotations required to build views and view_model libraries
kt_android_library(
    name = "annotations",
    custom_package = "org.oppia.app",
    srcs = ANNOTATION_FILES,
    deps = [
        ":dagger",
        "//model",
    ],
    visibility = ["//visibility:private"],
)

# Library for all view model files
kt_android_library(
    name = "view_models",
    custom_package = "org.oppia.app.vm",
    srcs = VIEW_MODEL_FILES,
    enable_data_binding = 1,
    manifest = "src/main/ViewModelManifest.xml",
    deps = [
        ":annotations",
        ":dagger",
        ":listeners",
        ":resources",
        "//domain",
        "//model",
        "//utility",
        artifact("androidx.databinding:databinding-common"),
        artifact("androidx.databinding:databinding-runtime"),
    ],
    visibility = ["//visibility:private"],
)

# TODO(#1566): Move Firebase rules to their own package & remove default visibility
'''
Package for all Firebase dependencies.
To reference these dependencies, add '//app:crashlytics' and '//app:crashlytics_deps'
to your build rule's dependency list.
'''
package(default_visibility = ["//visibility:public"])

GOOGLE_SERVICES_RESOURCES = google_services_xml(
    package_name = "org.oppia.app",
    google_services_json = "google-services.json",
)

crashlytics_android_library(
    name = "crashlytics",
    package_name = "org.oppia.app",
    build_id = "48fc9d17-e102-444c-8e0d-638d75ec0942",
    resource_files = GOOGLE_SERVICES_RESOURCES,
)

android_library(
    name = "crashlytics_deps",
    exports = [
        artifact("com.crashlytics.sdk.android:crashlytics"),
        artifact("io.fabric.sdk.android:fabric"),
        artifact("com.google.firebase:firebase-analytics"),
        artifact("com.google.firebase:firebase-crashlytics"),
    ],
)

dagger_rules()
